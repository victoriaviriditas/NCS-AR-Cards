<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>NCS Postcard AR â€” Image Tracking</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- A-Frame + MindAR (official CDN versions) -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <style>
      html, body { margin:0; height:100%; overflow:hidden; }
      a-scene { position: fixed; inset: 0; touch-action: none; }
      .hint { position:fixed; left:0; right:0; bottom:10px; text-align:center; font:14px/1.3 system-ui; color:#fff; }
    </style>

    <!-- Drag / Flick rotation component -->
    <script>
      AFRAME.registerComponent('spin-drag', {
        schema: { sensitivity: {default: 0.4}, inertia: {default: 0.95} },
        init() {
          this.dragging=false; this.prev=null; this.vel={x:0,y:0};
          this.onDown=this.onDown.bind(this); this.onMove=this.onMove.bind(this); this.onUp=this.onUp.bind(this);
          this.el.sceneEl.addEventListener('loaded', () => {
            const c=this.el.sceneEl.canvas;
            c.addEventListener('mousedown',this.onDown,{passive:false});
            window.addEventListener('mousemove',this.onMove,{passive:false});
            window.addEventListener('mouseup',this.onUp,{passive:false});
            c.addEventListener('touchstart',this.onDown,{passive:false});
            window.addEventListener('touchmove',this.onMove,{passive:false});
            window.addEventListener('touchend',this.onUp,{passive:false});
            window.addEventListener('touchcancel',this.onUp,{passive:false});
          });
        },
        remove() {
          const c=this.el.sceneEl && this.el.sceneEl.canvas; if(!c) return;
          c.removeEventListener('mousedown',this.onDown);
          window.removeEventListener('mousemove',this.onMove);
          window.removeEventListener('mouseup',this.onUp);
          c.removeEventListener('touchstart',this.onDown);
          window.removeEventListener('touchmove',this.onMove);
          window.removeEventListener('touchend',this.onUp);
          window.removeEventListener('touchcancel',this.onUp);
        },
        getPoint(e){ return (e.touches&&e.touches.length)?{x:e.touches[0].clientX,y:e.touches[0].clientY}:{x:e.clientX,y:e.clientY}; },
        onDown(e){ e.preventDefault(); this.dragging=true; this.prev=this.getPoint(e); this.vel.x=0; this.vel.y=0; },
        onMove(e){
          if(!this.dragging) return; e.preventDefault();
          const p=this.getPoint(e), dx=p.x-this.prev.x, dy=p.y-this.prev.y; this.prev=p;
          this.vel.x=dx; this.vel.y=dy; this.rotateBy(dx,dy);
        },
        onUp(){ this.dragging=false; this.prev=null; },
        rotateBy(dx,dy){
          const rot=this.el.getAttribute('rotation');
          rot.y += dx * this.data.sensitivity;
          rot.x += dy * this.data.sensitivity;
          this.el.setAttribute('rotation', rot);
        },
        tick(time,dt){ if(this.dragging) return; if(dt==null) dt=16;
          const scale=dt/16;
          if(Math.abs(this.vel.x)>0.01 || Math.abs(this.vel.y)>0.01){
            this.rotateBy(this.vel.x*scale, this.vel.y*scale);
            this.vel.x*=this.data.inertia; this.vel.y*=this.data.inertia;
          }
        }
      });
    </script>
  </head>

  <body>
    <!-- MindAR scene: point at your postcard image -->
    <a-scene
      mindar-image="imageTargetSrc: ./targets.mind"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
    >
      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <!-- Preload your cube images -->
      <a-assets>
        <img id="hirowife"   src="img/hirowife.png"   crossorigin="anonymous" />
        <img id="hirosquire" src="img/hirosquire.png" crossorigin="anonymous" />
        <img id="hiroknight" src="img/hiroknight.png" crossorigin="anonymous" />
        <img id="hirofriar"  src="img/hirofriar.png"  crossorigin="anonymous" />
        <img id="hirobottom" src="img/hirobottom.png" crossorigin="anonymous" />
        <img id="hirotitle"  src="img/hirotitle.png"  crossorigin="anonymous" />
      </a-assets>

      <!-- Attach content to the first image in targets.mind -->
      <a-entity mindar-image-target="targetIndex: 0">
        <!-- Put the cube slightly above the postcard surface (y = 0.5 * cube size) -->
        <a-entity id="photo-cube" position="0 0.5 0" spin-drag>
          <!-- Each face is a 1x1 plane, double-sided so they don't disappear when viewed from behind -->
          <!-- FRONT (+Z) -->
          <a-plane width="1" height="1" position="0 0 0.5" rotation="0 0 0"
                   material="src: #hirowife; side: double"></a-plane>
          <!-- BACK (-Z) -->
          <a-plane width="1" height="1" position="0 0 -0.5" rotation="0 180 0"
                   material="src: #hirosquire; side: double"></a-plane>
          <!-- RIGHT (+X) -->
          <a-plane width="1" height="1" position="0.5 0 0" rotation="0 -90 0"
                   material="src: #hiroknight; side: double"></a-plane>
          <!-- LEFT (-X) -->
          <a-plane width="1" height="1" position="-0.5 0 0" rotation="0 90 0"
                   material="src: #hirofriar; side: double"></a-plane>
          <!-- TOP (+Y) -->
          <a-plane width="1" height="1" position="0 0.5 0" rotation="-90 0 0"
                   material="src: #hirotitle; side: double"></a-plane>
          <!-- BOTTOM (-Y) -->
          <a-plane width="1" height="1" position="0 -0.5 0" rotation="90 0 0"
                   material="src: #hirobottom; side: double"></a-plane>
        </a-entity>
      </a-entity>
    </a-scene>

    <div class="hint">Point your camera at the postcard image to see the cube. Drag to spin. Flick to glide.</div>
  </body>
</html>
